<p class="text-success"><%= notice %></p>

<div class="container mt-4">
  <h1 class="mb-4"><%= @cabin.name %></h1>

  <div class="row">
    <!-- Cabin Image Carousel -->
    <% if @cabin.images.attached? %>
      <div class="col-md-6 mb-4">
        <div class="swiper">
          <div class="swiper-wrapper">
            <% @cabin.images.each do |image| %>
              <div class="swiper-slide">
                <%= image_tag image, class: 'swiper-slide img-fluid mx-auto d-block rounded', alt: "Cabin Image" %>
              </div>
            <% end %>
          </div>
          <!-- Add Pagination -->
          <div class="swiper-pagination"></div>
          <!-- Add Navigation -->
          <div class="swiper-button-next"></div>
          <div class="swiper-button-prev"></div>
        </div>
      </div>
    <% end %>

    <!-- Cabin Details -->
    <div class="col-md-6">
      <h3 class="mb-3">Average Rating: <%= @cabin.average_rating %></h3>
      <div class="mb-4">
        <%= link_to "Edit this cabin", edit_cabin_path(@cabin), class: 'btn btn-primary mr-2' %>
        <%= link_to "Back to cabins", cabins_path, class: 'btn btn-secondary mr-2' %>
        <%= button_to "Destroy this cabin", @cabin, method: :delete, class: 'btn btn-danger', data: { confirm: 'Are you sure?' } %>
      </div>

      <!-- Booking Form -->
      <%= form_with(model: [@cabin, @booking], local: true, id: "booking-form") do |f| %>
        <div class="form-group mb-3">
          <%= f.label :start_date, "Start Date" %>
          <%= f.date_field :start_date, class: 'form-control' %>
        </div>

        <div class="form-group mb-3">
          <%= f.label :end_date, "End Date" %>
          <%= f.date_field :end_date, class: 'form-control' %>
        </div>

        <%= f.hidden_field :total_price, id: "total-price" %> 

        <%= f.submit "Book Now", class: 'btn btn-primary' %>
      <% end %>

      <!-- Reviews Form -->
      <%= form_with model: [@cabin, @review], url: cabin_reviews_path(@cabin), local: true do |f| %>
        <div class="form-group mb-3">
          <label>Select Rating:</label>
          <div class="d-flex flex-wrap">
            <%= f.radio_button :rating, 1, id: 'rating_1', class: 'form-check-input' %>
            <%= image_tag 'scream.png', alt: 'scream (worst)', class: 'form-check-label mr-2' %>

            <%= f.radio_button :rating, 2, id: 'rating_2', class: 'form-check-input' %>
            <%= image_tag 'cry.png', alt: 'cry', class: 'form-check-label mr-2' %>

            <%= f.radio_button :rating, 3, id: 'rating_3', class: 'form-check-input' %>
            <%= image_tag 'huh.png', alt: 'Huh', class: 'form-check-label mr-2' %>

            <%= f.radio_button :rating, 4, id: 'rating_4', class: 'form-check-input' %>
            <%= image_tag 'amazing.png', alt: 'amazing', class: 'form-check-label mr-2' %>

            <%= f.radio_button :rating, 5, id: 'rating_5', class: 'form-check-input' %>
            <%= image_tag 'love.png', alt: 'love', class: 'form-check-label mr-2' %>
          </div>
        </div>

        <div class="form-group mb-3">
          <%= f.label :comment, "Your Comment" %>
          <%= f.text_area :comment, class: 'form-control' %>
        </div>

        <%= f.submit "Submit Review", class: 'btn btn-primary' %>
      <% end %>

      <!-- Reviews Section -->
      <h3 class="mt-4">Reviews:</h3>
      <% if @cabin.reviews.any? %>
        <% @cabin.reviews.each do |review| %>
          <div class="review mb-4 border p-3 rounded">
            <div class="rating mb-2">
              <%= image_tag review_image(review.rating), alt: "Rating: #{review.rating}", class: 'img-fluid' %>
            </div>
            <div class="comment mb-2">
              <p><%= review.comment %></p>
            </div>
            <div class="review-meta">
              <small class="text-muted">Reviewed by <%= review.user.email %> on <%= review.created_at.strftime("%Y-%m-%d") %></small>
              <% if current_user == review.user %>
                <%= button_to "Delete Review", cabin_review_path(@cabin, review), method: :delete, class: 'btn btn-danger btn-sm mt-2', data: { confirm: 'Are you sure you want to delete this review?' } %>
              <% end %>
            </div>
          </div>
        <% end %>
      <% else %>
        <p>No reviews yet. Be the first to leave a review!</p>
      <% end %>
    </div>
  </div>
</div>

<script>
document.addEventListener("turbo:load", function() {
  const bookedDates = <%= raw @booked_dates.to_json %>; 
  const dateFormat = "Y-m-d";

  function formatDate(date) {
    return date.toISOString().split('T')[0];
  }

  function isBooked(date) {
    return bookedDates.includes(formatDate(date));
  }

  flatpickr("#booking_start_date", {
    minDate: "today",
    dateFormat: dateFormat,
    disable: [
      function(date) {
        return isBooked(date);
      }
    ],
    onChange: function(selectedDates) {
      const startDate = selectedDates[0];
      if (startDate) {
        const endDate = document.querySelector("#booking_end_date").value;
        calculateTotalPrice(startDate, endDate);
      }
    }
  });

  flatpickr("#booking_end_date", {
    minDate: "today",
    dateFormat: dateFormat,
    disable: [
      function(date) {
        return isBooked(date);
      }
    ],
    onChange: function(selectedDates) {
      const endDate = selectedDates[0];
      const startDate = document.querySelector("#booking_start_date").value;
      if (startDate && endDate) {
        calculateTotalPrice(new Date(startDate), endDate);
      }
    }
  });

  function calculateTotalPrice(startDate, endDate) {
    const pricePerNight = parseFloat("<%= @cabin.price %>");
    const start = new Date(startDate);
    const end = new Date(endDate);

    if (start && end && end >= start) {
      const days = (end - start) / (1000 * 60 * 60 * 24) + 1;
      const totalPrice = days * pricePerNight;
      document.querySelector("#total-price").value = totalPrice.toFixed(2);
    } else {
      document.querySelector("#total-price").value = "";
    }
  }
});
</script>
